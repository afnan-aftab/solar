<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="FYP">
  <meta name="author" content="Afnan">

<!-- ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ -->
  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="/__/firebase/8.1.2/firebase-app.js"></script>
  <!-- Add the database Firebase JavaScript SDK -->
  <script src="/__/firebase/8.1.2/firebase-database.js"></script>
  <script src="/__/firebase/8.2.1/firebase-storage.js"></script>
  <!-- Import TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
  <!-- Import tfjs-vis -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js"></script>

<!-- ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ -->

  <title>FYP</title>

  <!-- Icon Image -->
  <link id="icon" type="image" sizes="64x64" rel="icon">
  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@422&display=swap" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">

</head>

<body>

  <nav class = "navbar navbar-dark bg-dark navbar-expand-sm">
    <div class = "container">
        <button class = "navbar-toggler" type = "button" data-toggle = "collapse" data-target = "#Navbar">
            <span class = "navbar-toggler-icon"></span>
        </button>
        <a class = "navbar-brand mr-auto" href = "./index.html"><img id="nav-img" height="64" width="64"></a>
        <div class = "collapse navbar-collapse" id = "Navbar">
            <ul class = "navbar-nav mr-auto">
                <li class = "nav-item"><a class = "nav-link" href = "./index.html">Home</a></li>
                <li class = "nav-item"><a class = "nav-link" href = "Gyro.html">Gyro</a></li>
                <li class = "nav-item"><a class = "nav-link" href = "power-plant.html">Power Plant</a></li>
                <li class = "nav-item active"><a class = "nav-link" href = "#">Machine Learning</a></li>
            </ul>
            <span class="navbar-text">
                <a id="login">
                    Login
                </a>
            </span>
        </div>
    </div>        
  </nav>

  <!--------Login Modal-------->

  <div id="loginModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" role="content">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Login</h4>
                <button type="button" class="close" data-dismiss="modal">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="form-group col-sm-4">
                                <label class="sr-only" for="exampleInputEmail3">Email address</label>
                                <input type="email" class="form-control form-control-sm mr-1" id="exampleInputEmail3" placeholder="Enter email">
                        </div>
                        <div class="form-group col-sm-4">
                            <label class="sr-only" for="exampleInputPassword3">Password</label>
                            <input type="password" class="form-control form-control-sm mr-1" id="exampleInputPassword3" placeholder="Password">
                        </div>
                        <div class="col-sm-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox">
                                <label class="form-check-label"> Remember me
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-secondary btn-sm ml-auto" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm ml-1">Sign in</button>        
                    </div>
                </form>
            </div>
        </div>
    </div>
  </div>

  <!--------Login Modal End-------->

  <main role="main">

    <!--------- Jumbotron --------->
    <div id="jumboML" class="jumbotron bg-cover text-light">
      <div class="container">
        <h1 class="display-3">Machine Learning</h1>
        <h3>Iot Based Home Solar Power System</h3>
        <p><a id="trainmodel" class="btn btn-primary btn-lg" role="button">Click to train model &raquo;</a></p>
      </div>
    </div>
    <!---------END Jumbotron --------->

    <div class="container">
      <div id="heading" class="row">
        <div class="col-lg-12 bg-dark text-light text-center">
          <h2>Data Statistics</h2>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div id="IrrvAC" height="300"></div>
        </div>
        <div class="col-md-6">
          <div id="AtempvAC" height="300"></div>
        </div>
      </div>
    </div>

  </main>

  <!--------To top Button-------->
  <button id="top_btn" type="button" class="btn btn-secondary btn-lg btn-circle text-light">&#x02227;</button>
  <!--------To top button End-------->

  <!-- Footer -->
  <footer class="page-footer font-small bg-dark footer-dark text-light">

    <!-- Copyright -->
    <div class="footer-copyright text-center py-3">Â© 2020 Copyright:
      <a href="https://www.instagram.com/afnan_aftab/"> Afnan Aftab</a>
    </div>
    <!-- Copyright -->
  
  </footer>
  <!-- Footer -->



<!-- ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ -->
  <!-- Initialize Firebase -->
  <script src="script.js"></script>
  <script>
//TENSORFLOW----------------------------------------------------------->

document.addEventListener("DOMContentLoaded", initial);

function initial(){
  tfvis.visor();
  tfvis.visor().close();
  plot_html();
}

async function getData() {

  const DataResponse = await fetch('https://storage.googleapis.com/iot-solar-database.appspot.com/solar_dataset/Dataset_json.json');
  const Data = await DataResponse.json();  
  
  return Data;
}

function plotting(data) {
  
  const values = data.map(d => ({
    x: d.IRRADIATION,
    y: d.AC_POWER,
  }));

  const values1 = data.map(d => ({
    x: d.AMBIENT_TEMPERATURE,
    y: d.AC_POWER,
  }));
  
  tfvis.render.scatterplot(
    document.getElementById('IrrvAC'),
    {values: values}, 
    {
      xLabel: 'IRRADIATION',
      yLabel: 'AC Power',
      height: 300
    }
  );

  tfvis.render.scatterplot(
    document.getElementById('AtempvAC'),
    {values: values1}, 
    {
      xLabel: 'AMBIENT_TEMPERATURE',
      yLabel: 'AC Power',
      height: 300
    }
  );

}

function createModel() {
  // Create a sequential model
  const model = tf.sequential(); 
  
  // Add a single input layer
  model.add(tf.layers.dense({inputShape: [3], units: 20, activation:'relu', kernel_initializer:'he_uniform', useBias: true}));

  // adding extra layers
  
  // Add an output layer
  model.add(tf.layers.dense({units: 2, useBias: true}));

  return model;
}

function convertToTensor(data) {
  // Wrapping these calculations in a tidy will dispose any 
  // intermediate tensors.
  
  return tf.tidy(() => {
    // Step 1. Shuffle the data    
    tf.util.shuffle(data);

    // Step 2. Convert data to Tensor
    const inputs_I  = data.map(d => d.IRRADIATION)
    const inputs_AT = data.map(d => d.AMBIENT_TEMPERATURE)
    const inputs_MT = data.map(d => d.MODULE_TEMPERATURE)
    var inputs = [];
    for(i=0;i<inputs_I.length;i++){
      inputs[inputs.length]=inputs_I[i];
      inputs[inputs.length]=inputs_AT[i];
      inputs[inputs.length]=inputs_MT[i];
    }

    const labels_AC = data.map(d => d.AC_POWER);
    const labels_DC = data.map(d => d.DC_POWER);

    var labels = [];
    for(i=0;i<labels_AC.length;i++){
      labels[labels.length]=labels_AC[i];
      labels[labels.length]=labels_DC[i];
    }

    const inputTensor = tf.tensor2d(inputs, [inputs.length/3, 3]);
    const labelTensor = tf.tensor2d(labels, [labels.length/2, 2]);

    //Step 3. Normalize the data to the range 0 - 1 using min-max scaling
    const inputMax = inputTensor.max();
    const inputMin = inputTensor.min();  
    const labelMax = labelTensor.max();
    const labelMin = labelTensor.min();

    const normalizedInputs = inputTensor.sub(inputMin).div(inputMax.sub(inputMin));
    const normalizedLabels = labelTensor.sub(labelMin).div(labelMax.sub(labelMin));
    return {
      inputs: normalizedInputs,
      labels: normalizedLabels,
      // Return the min/max bounds so we can use them later.
      inputMax,
      inputMin,
      labelMax,
      labelMin,
    }
  });  
}

async function trainModel(model, inputs, labels) {
  // Prepare the model for training.  
  model.compile({
    optimizer: tf.train.adam(),
    loss: tf.losses.meanSquaredError,
    metrics: ['mse'],
  });
  
  const batchSize = 32;
  const epochs = 50;
  var es = tf.callbacks.earlyStopping({monitor: 'loss'})
  var plot_loss = tfvis.show.fitCallbacks(
      { name: 'Training Performance', tab:'Model Training' },
      ['loss', 'mse'], 
      { height: 200, callbacks: ['onEpochEnd'] }
    );
  
  return await model.fit(inputs, labels, {
    batchSize,
    epochs,
    shuffle: true,
    callbacks: plot_loss,es
  });
}

function testModel(model, inputData, normalizationData) {
  const {inputMax, inputMin, labelMin, labelMax} = normalizationData;  
  
  // Generate predictions for a uniform range of numbers between 0 and 1;
  // We un-normalize the data by doing the inverse of the min-max scaling 
  // that we did earlier.
  const [xs, preds] = tf.tidy(() => {

    const inputs_I  = inputData.map(d => d.IRRADIATION)
    const inputs_AT = inputData.map(d => d.AMBIENT_TEMPERATURE)
    const inputs_MT = inputData.map(d => d.MODULE_TEMPERATURE)
    var inputs = [];
    for(i=0;i<inputs_I.length;i++){
      if(inputs_I[i]>0){
        inputs[inputs.length]=inputs_I[i];
        inputs[inputs.length]=inputs_AT[i];
        inputs[inputs.length]=inputs_MT[i];
      }
    }   
    
    const inputTensor = tf.tensor2d(inputs, [inputs.length/3, 3]);
    const normalizedInputs = inputTensor.sub(inputMin).div(inputMax.sub(inputMin));
    const xs = normalizedInputs;
    //const xs = tf.linspace(0, 1, 100);      
    const preds = model.predict(xs);      
    
    const unNormXs = xs
      .mul(inputMax.sub(inputMin))
      .add(inputMin);
    
    const unNormPreds = preds
      .mul(labelMax.sub(labelMin))
      .add(labelMin);
    
    // Un-normalize the data
    return [unNormXs.dataSync(), unNormPreds.dataSync()];
  });

  var xs_arr = Array.from(xs);
  var preds_arr = Array.from(preds);
  var irr_arr = [];
  var at_arr = [];
  var mt_arr = [];
  var ac_arr = [];
  var dc_arr = [];

  for(i=0;i<preds_arr.length;i++){
    if(i%2==0){
      ac_arr[ac_arr.length] = preds_arr[i];
    }else{
      dc_arr[dc_arr.length] = preds_arr[i];
    }
  }

  for(i=0;i<xs_arr.length;i++){
    irr_arr[irr_arr.length] = xs_arr[i];
    i++;
    at_arr[at_arr.length] = xs_arr[i];
    i++;
    mt_arr[mt_arr.length] = xs_arr[i];
  }

  var o = [];
  for(i=0;i<irr_arr.length;i++){
    var x = {
      'IRRADIATION':irr_arr[i],
      'AMBIENT_TEMPERATURE':at_arr[i],
      'MODULE_TEMPERATURE':mt_arr[i],
      'AC_POWER':ac_arr[i],
      'DC_POWER':dc_arr[i]
    };
    o.push(x);
  }

  const predictedPoints = o.map(d => {
    return {x: d.IRRADIATION, y: d.AC_POWER,};
  });
  
  const originalPoints = inputData.map(d => ({
    x: d.IRRADIATION, y: d.AC_POWER,
  }));

  const predictedPoints1 = o.map(d => {
    return {x: d.IRRADIATION, y: d.DC_POWER,};
  });
  
  const originalPoints1 = inputData.map(d => ({
    x: d.IRRADIATION, y: d.DC_POWER,
  }));
  
  
  tfvis.render.scatterplot(
    {name: 'Irradiation vs AC Power',tab:'Result Charts'}, 
    {values: [originalPoints, predictedPoints], series: ['original', 'predicted']}, 
    {
      xLabel: 'Irradiation',
      yLabel: 'AC Power',
      height: 300
    }
  );

  tfvis.render.scatterplot(
    {name: 'Irradiation vs DC Power',tab:'Result Charts'}, 
    {values: [originalPoints1, predictedPoints1], series: ['original', 'predicted']}, 
    {
      xLabel: 'Irradiation',
      yLabel: 'DC POWER',
      height: 300
    }
  );
}

async function plot_html(){
  const data = await getData();
  plotting(data);
}

async function run(){
  // Load and plot the original input data that we are going to train on.
  const data = await getData();
  plotting(data);
  // Create the model
  const model = createModel();  
  tfvis.show.modelSummary({name: 'Model Summary',tab:"Model Summary"}, model);
  tfvis.show.layer({name: 'Model Layers',tab:"Model Summary"}, model.getLayer(undefined, 1));
  
  // Convert the data to a form we can use for training.
  const tensorData = convertToTensor(data);
  const {inputs, labels} = tensorData;
    
  // Train the model  
  await trainModel(model, inputs, labels);
  console.log('Done Training');

  // Make some predictions using the model and compare them to the
  // original data
  testModel(model, data, tensorData);
}

$(document).ready(function(){
  $("#trainmodel").click(function(){

    tfvis.visor().open();
    run();

  });
});

//END TENSORFLOW------------------------------------------------------->

  </script>
<!-- ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ -->


</body>
</html>